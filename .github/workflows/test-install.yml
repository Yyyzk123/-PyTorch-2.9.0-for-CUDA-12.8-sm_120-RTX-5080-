name: Test Install PyTorch & torchvision Wheels

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  install-test:
    runs-on: ubuntu-latest

    # CUDA 12.8.1 运行时镜像（含 cuDNN 9）
    container:
      image: nvidia/cuda:12.8.1-cudnn-runtime-ubuntu24.04

    steps:
    # 0️⃣ 取仓库代码
    - name: Checkout repository
      uses: actions/checkout@v4

    # 1️⃣ 安装基础依赖并注入 cuDNN 8
    - name: Install system deps & cuDNN 8
      run: |
        set -e
        apt-get update -qq
        apt-get install -y --no-install-recommends wget curl ca-certificates python3-pip tar
          wget curl ca-certificates python3-pip tar xz-utils       
                   
        # ↓ 下载并安装 cuDNN 8.9.7（适配 CUDA 12）
        CUDNN_VER=8.9.7.29
        CUDA_VER=12
        wget -q https://developer.download.nvidia.com/compute/cudnn/redist/cudnn/linux-x86_64/cudnn-linux-x86_64-${CUDNN_VER}_cuda${CUDA_VER}-archive.tar.xz
        tar -xf cudnn-linux-x86_64-${CUDNN_VER}_cuda${CUDA_VER}-archive.tar.xz
        cp -P cudnn-linux-x86_64-${CUDNN_VER}_cuda${CUDA_VER}-archive/include/* /usr/local/cuda/include/
        cp -P cudnn-linux-x86_64-${CUDNN_VER}_cuda${CUDA_VER}-archive/lib/*      /usr/local/cuda/lib64/
        chmod a+r /usr/local/cuda/lib64/libcudnn*
        ldconfig
        echo "Installed cuDNN libs:"; ls /usr/local/cuda/lib64/libcudnn.so.*

        
    - name: Set up micromamba (Python 3.10)
      run: |
        curl -Ls https://micro.mamba.pm/api/micromamba/linux-64/latest | tar -xvj bin/micromamba
        ./bin/micromamba create -y -p $HOME/py310 python=3.10
        echo "$HOME/py310/bin" >> $GITHUB_PATH

    - name: Download wheels from latest GitHub Release
      id: download
      run: |
        set -e
        mkdir -p dist
        REPO="${{ github.repository }}"
        WHL_URLS=$(curl -s https://api.github.com/repos/$REPO/releases/latest \
          | grep browser_download_url | grep '.whl"' | cut -d '"' -f 4)
        [ -z "$WHL_URLS" ] && { echo "::error ::No wheels found in latest release"; exit 1; }
        echo "Found wheels:"
        echo "$WHL_URLS"
        for URL in $WHL_URLS; do
          FILE=$(basename "$URL")
          echo "↓ $FILE"
          wget -q "$URL" -O dist/"$FILE"
          sha256sum dist/"$FILE"
        done

    - name: Install wheels & Python deps
      run: |
        python -m pip install --no-cache-dir dist/torch-*.whl
        python -m pip install --no-cache-dir dist/torchvision-*.whl
        python -m pip install --no-cache-dir -r requirements.txt

    - name: Verify installation
      run: |
        python examples/demo_tensor_cuda.py || true
        python - <<'PY'
        import torch, platform
        print("Python  :", platform.python_version())
        print("Torch   :", torch.__version__)
        print("CUDA OK :", torch.cuda.is_available())
        if torch.cuda.is_available():
            print("GPU Name:", torch.cuda.get_device_name(0))
            print("sm arch :", torch.cuda.get_device_capability())
        else:
            print("GPU Name: (no GPU, CI runner)")
        import torchvision
        print("TorchVision:", torchvision.__version__)
        PY

    - name: Final result
      run: echo "✅ CI completed — wheels install successfully!"
