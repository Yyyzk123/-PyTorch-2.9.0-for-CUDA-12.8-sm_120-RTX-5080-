name: Test Install PyTorch Wheel

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  install-test:
    runs-on: ubuntu-latest

    container:
      image: nvidia/cuda:12.8.1-cudnn-runtime-ubuntu24.04  # âœ… ä¿®æ­£ä¸º Ubuntu 24.04 å¯¹åº”é•œåƒ

    steps:
      - uses: actions/checkout@v4
        name: Checkout repository

      # â‘  å®‰è£…ç³»ç»Ÿä¾èµ– + cuDNN + OpenBLAS + NUMA + OpenMP
      - name: Install system dependencies, cuDNN, OpenBLAS
        run: |
          set -e
          apt-get update -qq
          apt-get install -y wget curl python3-pip software-properties-common gnupg ca-certificates

          # â• å¿…éœ€ä¾èµ–ï¼Œä¿®å¤ torch._C åŠ è½½å¤±è´¥
          apt-get install -y libnuma1 libgomp1
          apt-get install -y libopenblas0-pthread libopenblas-dev
          
          # ğŸ”° å…œåº•ï¼šè‹¥é•œåƒç¼º libcudnn.so.8 å°±è‡ªåŠ¨è£…
          if ! ldconfig -p | grep -q "libcudnn.so.8"; then
            echo "âš ï¸  cuDNN runtime not found in image â€” installing from APT..."
            apt-get update -qq
            apt-get install -y libcudnn8
          fi
     
      # â‘¡ å®‰è£… Python 3.10
      - name: Set up Python 3.10
        run: |
          set -e
          add-apt-repository ppa:deadsnakes/ppa -y
          apt-get update -qq
          apt-get install -y python3.10 python3.10-venv python3.10-dev python3.10-distutils
          # ç»‘å®š python å’Œ python3 åˆ° 3.10
          update-alternatives --install /usr/bin/python python /usr/bin/python3.10 1
          update-alternatives --install /usr/bin/python3 python3 /usr/bin/python3.10 1
          # pip & ensurepip
          python3.10 -m ensurepip --upgrade
          # å¦‚æ— ç‰¹æ®Šéœ€æ±‚ï¼Œä¿æŒç³»ç»Ÿ pip 24ï¼Œçœå»å‡çº§å†²çª


      # â‘¢ ä¸‹è½½ wheel æ–‡ä»¶
      - name: Download wheel from latest GitHub release
        id: download
        run: |
          set -e
          mkdir -p dist
          RELEASE_URL=$(curl -s https://api.github.com/repos/${{ github.repository }}/releases/latest \
            | grep browser_download_url \
            | grep '.whl"' \
            | cut -d '"' -f 4)
          if [ -z "$RELEASE_URL" ]; then
            echo "No release found. Skipping wheel test."
            exit 0
          fi
          WHEEL_NAME=$(basename "$RELEASE_URL")
          wget "$RELEASE_URL" -O "dist/$WHEEL_NAME"
          echo "WHEEL_NAME=$WHEEL_NAME" >> "$GITHUB_OUTPUT"
          
          # â• è¾“å‡º SHA256 æ ¡éªŒå’Œï¼ˆéå¼ºåˆ¶ï¼‰
          sha256sum "dist/$WHEEL_NAME"

      # â‘£ å®‰è£… wheel
      - name: Install from wheel
        if: steps.download.outputs.WHEEL_NAME
        run: |
          chmod +x install_from_whl.sh
          ./install_from_whl.sh "dist/${{ steps.download.outputs.WHEEL_NAME }}"

      # â‘¤ éªŒè¯ torch + CUDA æ­£å¸¸æ€§
      - name: Verify installation
        if: steps.download.outputs.WHEEL_NAME
        run: |
          echo "Running demo_tensor_cuda.py..."
          python examples/demo_tensor_cuda.py

          echo "Running CUDA check..."
          python -c "import torch; print('âœ… torch.cuda.is_available():', torch.cuda.is_available())"

      # âœ… ç»“æŸæ ‡è®°
      - name: Final check
        if: always()
        run: echo "âœ… Test complete! Believe in light, your PyTorch wheel is ready to shine!"
